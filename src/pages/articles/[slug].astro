---
/**
 * Page Article individuel - Détail d'un article
 *
 * Route dynamique : /articles/[slug]
 *
 * getStaticPaths() génère une route pour chaque article existant.
 * Le contenu HTML est récupéré depuis Hashnode et rendu directement.
 *
 * Layout: TOC à gauche, contenu à droite (comme le template original)
 */

import Breadcrumbs from '@/components/Breadcrumbs.astro'
import Link from '@/components/Link.astro'
import PageHead from '@/components/PageHead.astro'
import PostNavigation from '@/components/PostNavigation.astro'
import TOCHeader from '@/components/TOCHeader.astro'
import TOCSidebar from '@/components/TOCSidebar.astro'
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'

// Import des fonctions API Hashnode
import { getAllPosts, getPostBySlug, formatDate, extractHeadingsFromHtml, getAdjacentPosts } from '@/lib/hashnode/api'
import type { Post } from '@/lib/hashnode/types'

// Génère toutes les routes possibles au moment du build
export async function getStaticPaths() {
  const allPosts = await getAllPosts(50)  // Limite API: 50 max

  return allPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }))
}

const { slug } = Astro.params
const { post: initialPost } = Astro.props as { post: Post }

// Récupère les détails complets de l'article (avec le contenu HTML)
let post: Post | null = null

try {
  post = await getPostBySlug(slug as string)

  // Si getPostBySlug retourne null, utiliser initialPost comme fallback
  if (!post && initialPost) {
    console.log(`[Article Page] getPostBySlug returned null for "${slug}", using initialPost as fallback`)
    post = initialPost
  }
} catch (error) {
  console.error(`Erreur lors de la récupération de l'article "${slug}":`, error)
  post = initialPost
}

// Récupère les articles adjacents pour la navigation Previous/Next
const { older, newer } = await getAdjacentPosts(slug as string)

// Formatage de la date
const publishedDate = post ? formatDate(post.publishedAt) : ''

// Extraction des headings pour la TOC
const headings = post?.content?.html ? extractHeadingsFromHtml(post.content.html) : []

// Breadcrumbs (pour le composant Breadcrumbs.astro)
const breadcrumbItems = [
  { label: 'Articles', href: '/articles' },
  { label: post?.title || 'Article' },
]
---

<Layout class="max-w-3xl xl:max-w-6xl">
  <PageHead
    slot="head"
    title={post?.title || 'Article'}
    description={post?.brief || 'Un article'}
  />

  <!-- TOC Mobile (affiché dans le header sticky) -->
  {headings.length > 0 && (
    <TOCHeader headings={headings} slot="table-of-contents" />
  )}

  {post ? (
    <>
      <!-- Breadcrumbs (full width, before grid) -->
      <div class="py-4">
        <Breadcrumbs items={breadcrumbItems} />
      </div>

      <!-- Header de l'article (centré, full width) -->
      <header class="py-8 border-b border-border text-center">
        <!-- Série (si l'article appartient à une série) -->
        {post.series && (
          <Link
            href={`/series/${post.series.slug}`}
            class="inline-flex items-center gap-1.5 text-sm text-primary hover:underline mb-4"
          >
            <Icon name="lucide:layers" class="size-4" />
            {post.series.name}
          </Link>
        )}

        <!-- Titre -->
        <h1 class="text-3xl sm:text-4xl font-bold mb-4 leading-tight">
          {post.title}
        </h1>

        <!-- Métadonnées (centrées) -->
        <div class="flex flex-wrap items-center justify-center gap-4 text-sm text-muted-foreground">
          <!-- Date -->
          <time datetime={post.publishedAt}>
            {publishedDate}
          </time>

          <span class="text-muted-foreground/40">|</span>

          <!-- Temps de lecture -->
          <span class="flex items-center gap-1">
            <Icon name="lucide:clock" class="size-4" />
            {post.readTimeInMinutes} min read
          </span>
        </div>

        <!-- Tags (centrés) -->
        {post.tags && post.tags.length > 0 && (
          <div class="flex flex-wrap justify-center gap-2 mt-4">
            {post.tags.map((tag) => (
              <span class="text-xs px-2 py-1 rounded-full bg-muted text-muted-foreground">
                # {tag.name}
              </span>
            ))}
          </div>
        )}
      </header>

      <!-- Navigation Previous/Next Post -->
      <div class="py-6">
        <PostNavigation
          newerPost={newer ? { title: newer.title, slug: newer.slug } : undefined}
          olderPost={older ? { title: older.title, slug: older.slug } : undefined}
        />
      </div>

      <!-- Layout grid: TOC à gauche + contenu à droite sur desktop -->
      <div class="xl:grid xl:grid-cols-[280px_1fr] xl:gap-8">
        <!-- TOC Sidebar pour desktop (sticky, à gauche) -->
        {headings.length > 0 && (
          <TOCSidebar headings={headings} />
        )}

        <article>
          <!-- Image de couverture -->
          {post.coverImage && (
            <div class="pb-8">
              <img
                src={post.coverImage.url}
                alt={post.title}
                class="w-full rounded-lg"
              />
            </div>
          )}

          <!-- Contenu de l'article -->
          <div class="prose prose-neutral dark:prose-invert max-w-none">
            {post.content?.html ? (
              <Fragment set:html={post.content.html} />
            ) : (
              <p class="text-muted-foreground">Contenu non disponible.</p>
            )}
          </div>

          <!-- Navigation retour -->
          <nav class="py-8 border-t border-border flex items-center justify-between">
            <Link
              href="/articles"
              class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 transition-colors"
            >
              <Icon name="lucide:arrow-left" class="size-4" />
              All articles
            </Link>

            {post.series && (
              <Link
                href={`/series/${post.series.slug}`}
                class="text-sm text-primary hover:underline flex items-center gap-2"
              >
                More in {post.series.name}
                <Icon name="lucide:arrow-right" class="size-4" />
              </Link>
            )}
          </nav>
        </article>
      </div>
    </>
  ) : (
    <!-- Article non trouvé -->
    <section class="py-12 text-center">
      <Icon name="lucide:alert-circle" class="size-12 text-muted-foreground/50 mx-auto mb-4" />
      <h1 class="text-2xl font-bold mb-2">Article non trouvé</h1>
      <p class="text-muted-foreground mb-6">
        L'article que vous recherchez n'existe pas ou a été supprimé.
      </p>
      <Link
        href="/articles"
        class="text-primary hover:underline flex items-center justify-center gap-2"
      >
        <Icon name="lucide:arrow-left" class="size-4" />
        Retour aux articles
      </Link>
    </section>
  )}
</Layout>
