---
/**
 * Individual Article Page - Article detail
 *
 * Dynamic route: /articles/[slug]
 *
 * Adapted from the original astro-erudite template for Hashnode.
 * Layout: TOC on left, content on right (like original template)
 */

import Breadcrumbs from "@/components/Breadcrumbs.astro";
import Link from "@/components/Link.astro";
import PageHead from "@/components/PageHead.astro";
import PostNavigation from "@/components/PostNavigation.astro";
import SeriesNavCard from "@/components/SeriesNavCard.astro";
import TOCHeader from "@/components/TOCHeader.astro";
import TOCSidebar from "@/components/TOCSidebar.astro";
import { badgeVariants } from "@/components/ui/badge";
import Layout from "@/layouts/Layout.astro";
import { Icon } from "astro-icon/components";

import {
	getAllPosts,
	getPostBySlug,
	getSeriesBySlug,
	formatDate,
	extractHeadingsFromHtml,
	getAdjacentPosts,
} from "@/lib/hashnode/api";
import type { Post, Series } from "@/lib/hashnode/types";

// Generate all possible routes at build time
export async function getStaticPaths() {
	const allPosts = await getAllPosts(50);

	return allPosts.map((post) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

const { slug } = Astro.params;
const { post: initialPost } = Astro.props as { post: Post };

// Fetch complete article details (with HTML content)
let post: Post | null = null;

try {
	post = await getPostBySlug(slug as string);

	// If getPostBySlug returns null, use initialPost as fallback
	if (!post && initialPost) {
		console.log(
			`[Article Page] getPostBySlug returned null for "${slug}", using initialPost as fallback`,
		);
		post = initialPost;
	}
} catch (error) {
	console.error(`Error fetching article "${slug}":`, error);
	post = initialPost;
}

// Fetch adjacent articles for Previous/Next navigation
const { older, newer } = await getAdjacentPosts(slug as string);

// Fetch complete series data if the article belongs to a series
let seriesData: Series | null = null;
if (post?.series?.slug) {
	try {
		seriesData = await getSeriesBySlug(post.series.slug);
	} catch (error) {
		console.error(`Error fetching series "${post.series.slug}":`, error);
	}
}

// Date formatting
const publishedDate = post ? formatDate(post.publishedAt) : "";

// Extract headings for TOC
const headings = post?.content?.html
	? extractHeadingsFromHtml(post.content.html)
	: [];

// Breadcrumbs with icons
const breadcrumbItems = [
	{ label: "Articles", href: "/articles", icon: "lucide:library-big" },
	{ label: post?.title || "Article", icon: "lucide:book-open-text" },
];
---

<Layout>
  <PageHead
    slot="head"
    title={post?.title || 'Article'}
    description={post?.brief || 'An article'}
  />

  <!-- TOC Mobile (displayed in sticky header) -->
  {headings.length > 0 && (
    <TOCHeader headings={headings} slot="table-of-contents" />
  )}

  {post ? (
    <section
      class="grid grid-cols-[minmax(0px,1fr)_min(calc(var(--breakpoint-md)-2rem),100%)_minmax(0px,1fr)] gap-y-6"
    >
      <!-- Breadcrumbs -->
      <div class="col-start-2">
        <Breadcrumbs items={breadcrumbItems} />
      </div>

      <!-- Cover image -->
      {post.coverImage && (
        <img
          src={post.coverImage.url}
          alt={post.title}
          class="col-start-2 w-full rounded-lg"
        />
      )}

      <!-- Article header (centered) -->
      <section class="col-start-2 flex flex-col gap-y-6 text-center">
        <div class="flex flex-col">
          <!-- Series (if article belongs to a series) -->
          {post.series && (
            <Link
              href={`/series/${post.series.slug}`}
              class="inline-flex items-center justify-center gap-1.5 text-sm text-primary hover:underline mb-2"
            >
              <Icon name="lucide:layers" class="size-4" />
              {post.series.name}
            </Link>
          )}

          <!-- Title -->
          <h1
            class="mb-2 scroll-mt-31 text-3xl leading-tight font-medium sm:text-4xl"
            id="post-title"
          >
            {post.title}
          </h1>

          <!-- Metadata -->
          <div
            class="text-muted-foreground divide-border mb-4 flex flex-col items-center justify-center divide-y text-xs sm:flex-row sm:flex-wrap sm:divide-x sm:divide-y-0 sm:text-sm"
          >
            <div class="flex w-full items-center justify-center gap-2 py-2 sm:w-fit sm:px-2 sm:py-0 first:sm:pl-0 last:sm:pr-0">
              <span>{publishedDate}</span>
            </div>

            <div class="flex w-full items-center justify-center gap-2 py-2 sm:w-fit sm:px-2 sm:py-0 first:sm:pl-0 last:sm:pr-0">
              <span>{post.readTimeInMinutes} min read</span>
            </div>
          </div>

          <!-- Tags -->
          {post.tags && post.tags.length > 0 && (
            <div class="flex flex-wrap justify-center gap-2">
              {post.tags.map((tag) => (
                <a
                  href={`/tags/${tag.slug}`}
                  class={badgeVariants({ variant: 'muted' })}
                >
                  <Icon name="lucide:hash" class="size-3" />
                  {tag.name}
                </a>
              ))}
            </div>
          )}
        </div>

        <!-- Navigation Previous/Next Post -->
        <PostNavigation
          newerPost={newer ? { title: newer.title, slug: newer.slug } : undefined}
          olderPost={older ? { title: older.title, slug: older.slug } : undefined}
        />
      </section>

      <!-- Wrapper for TOC + Content (always aligned) -->
      <div class="col-span-full grid grid-cols-[minmax(0px,1fr)_min(calc(var(--breakpoint-md)-2rem),100%)_minmax(0px,1fr)]">
        <!-- TOC Sidebar for desktop (left, close to content) -->
        {headings.length > 0 && (
          <div class="col-start-1 flex justify-end pr-12">
            <TOCSidebar headings={headings} />
          </div>
        )}

        <!-- Article content -->
        <article class="prose col-start-2 max-w-none dark:prose-invert">
          {post.content?.html ? (
            <Fragment set:html={post.content.html} />
          ) : (
            <p class="text-muted-foreground">Content not available.</p>
          )}

          <!-- Series navigation card (only if article belongs to a series) -->
          {seriesData && seriesData.posts?.edges && (
            <SeriesNavCard
              seriesName={seriesData.name}
              seriesSlug={seriesData.slug}
              seriesDescription={seriesData.description?.text}
              posts={seriesData.posts.edges.map(edge => edge.node)}
              currentSlug={slug as string}
            />
          )}
        </article>
      </div>

      <!-- Navigation Previous/Next Post (end of article) -->
      <div class="col-start-2">
        <PostNavigation
          newerPost={newer ? { title: newer.title, slug: newer.slug } : undefined}
          olderPost={older ? { title: older.title, slug: older.slug } : undefined}
        />
      </div>
    </section>
  ) : (
    <!-- Not found state -->
    <section class="py-12 text-center">
      <p class="text-xl text-muted-foreground">
        No article found! Soon to come ðŸš€
      </p>
    </section>
  )}
</Layout>
