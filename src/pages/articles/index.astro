---
/**
 * Articles Page - List of all articles
 *
 * Displays all published articles from Hashnode, sorted by date.
 * Each article is clickable and leads to its detail page.
 */

import ArticleCard from "@/components/ArticleCard.astro";
import PageHead from "@/components/PageHead.astro";
import Layout from "@/layouts/Layout.astro";

import { getAllPosts } from "@/lib/hashnode/api";
import type { Post } from "@/lib/hashnode/types";

// Fetch all articles
let allPosts: Post[] = [];

try {
	allPosts = await getAllPosts(50);
} catch (error) {
	console.error("Error fetching articles:", error);
}

// Group articles by year
type PostsByYear = { [year: string]: Post[] };

const postsByYear: PostsByYear = allPosts.reduce((acc, post) => {
	const year = new Date(post.publishedAt).getFullYear().toString();
	if (!acc[year]) {
		acc[year] = [];
	}
	acc[year].push(post);
	return acc;
}, {} as PostsByYear);

// Sort years from newest to oldest
const sortedYears = Object.keys(postsByYear).sort(
	(a, b) => Number(b) - Number(a),
);

const pageTitle = "Articles";
const pageDescription = "All articles and writings.";

// ISR: Cache 1s on Vercel (like Hashnode starter-kit)
Astro.response.headers.set(
	"Cache-Control",
	"s-maxage=1, stale-while-revalidate=59",
);
---

<Layout class="max-w-3xl">
  <PageHead slot="head" title={pageTitle} description={pageDescription} />

  <!-- Header -->
  <section class="py-8 border-b border-border">
    <h1 class="text-3xl font-bold mb-2">{pageTitle}</h1>
    <p class="text-muted-foreground">
      {pageDescription}
      {allPosts.length > 0 && (
        <span class="text-sm">({allPosts.length} articles)</span>
      )}
    </p>
  </section>

  <!-- Articles list by year -->
  {allPosts.length > 0 ? (
    <section class="py-8">
      {sortedYears.map((year) => (
        <div class="mb-12">
          <!-- Year as separator -->
          <h2 class="text-lg font-semibold text-muted-foreground mb-4 sticky top-20 bg-background py-2 z-10">
            {year}
          </h2>

          <div class="border-t border-border">
            {postsByYear[year].map((post) => (
              <ArticleCard post={post} />
            ))}
          </div>
        </div>
      ))}
    </section>
  ) : (
    <!-- Empty state -->
    <section class="py-12 text-center">
      <p class="text-xl text-muted-foreground">
        No articles published yet! Soon to come ðŸš€
      </p>
    </section>
  )}
</Layout>
