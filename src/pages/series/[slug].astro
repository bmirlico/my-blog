---
/**
 * Individual Series Page - Series detail with its articles
 *
 * Dynamic route: /series/[slug]
 *
 * getStaticPaths() generates a route for each existing series.
 * This allows Astro to pre-generate all pages at build time.
 */

import ArticleCard from "@/components/ArticleCard.astro";
import Link from "@/components/Link.astro";
import PageHead from "@/components/PageHead.astro";
import Layout from "@/layouts/Layout.astro";
import { Icon } from "astro-icon/components";

import { getAllSeries, getSeriesBySlug } from "@/lib/hashnode/api";
import type { Series, Post } from "@/lib/hashnode/types";

// Generate all possible routes at build time
export async function getStaticPaths() {
	const allSeries = await getAllSeries(20);

	return allSeries.map((series) => ({
		params: { slug: series.slug },
		props: { series },
	}));
}

interface Props {
	series: Series;
}

const { slug } = Astro.params;
const { series: initialSeries } = Astro.props;

// Fetch complete series details (with all articles)
let series: Series | null = null;
let posts: Post[] = [];

try {
	series = await getSeriesBySlug(slug as string);
	if (series?.posts?.edges) {
		posts = series.posts.edges.map((edge) => edge.node);
	}
} catch (error) {
	console.error(`Error fetching series "${slug}":`, error);
	series = initialSeries;
}

const breadcrumbs = [
	{ label: "Home", href: "/" },
	{ label: "Series", href: "/series" },
	{ label: series?.name || "Series", href: "" },
];

// ISR: Cache 60s on Vercel, stale-while-revalidate 5min
Astro.response.headers.set(
	"Cache-Control",
	"s-maxage=60, stale-while-revalidate=300",
);
---

<Layout class="max-w-3xl">
  <PageHead
    slot="head"
    title={series?.name || 'Series'}
    description={series?.description?.text || 'A series of articles'}
  />

  {series ? (
    <>
      <!-- Breadcrumbs -->
      <nav class="py-4 text-sm text-muted-foreground">
        <ol class="flex items-center gap-2">
          {breadcrumbs.map((crumb, index) => (
            <>
              {index > 0 && <Icon name="lucide:chevron-right" class="size-4" />}
              {crumb.href ? (
                <Link href={crumb.href} class="hover:text-foreground transition-colors">
                  {crumb.label}
                </Link>
              ) : (
                <span class="text-foreground font-medium">{crumb.label}</span>
              )}
            </>
          ))}
        </ol>
      </nav>

      <!-- Series header -->
      <header class="py-8 border-b border-border">
        <!-- Cover image -->
        {series.coverImage && (
          <div class="mb-6 rounded-lg overflow-hidden aspect-video">
            <img
              src={series.coverImage}
              alt={series.name}
              class="w-full h-full object-cover"
            />
          </div>
        )}

        <div class="flex items-center gap-3 mb-4">
          <span class="text-xs px-2 py-1 rounded-full bg-muted text-muted-foreground font-medium">
            {posts.length} {posts.length > 1 ? 'articles' : 'article'}
          </span>
          <span class="text-xs text-primary font-medium">Series</span>
        </div>

        <h1 class="text-3xl font-bold mb-4">{series.name}</h1>

        {series.description?.text && (
          <p class="text-lg text-muted-foreground">
            {series.description.text}
          </p>
        )}
      </header>

      <!-- Series articles list -->
      <section class="py-8">
        <h2 class="text-sm font-semibold uppercase tracking-wider text-muted-foreground mb-6">
          Articles in this series
        </h2>

        {posts.length > 0 ? (
          <div class="border-t border-border">
            {posts.map((post, index) => (
              <div class="relative">
                <!-- Article number in series -->
                <div class="absolute -left-8 top-6 text-xs text-muted-foreground/50 font-medium">
                  {String(index + 1).padStart(2, '0')}
                </div>
                <ArticleCard post={post} />
              </div>
            ))}
          </div>
        ) : (
          <p class="text-muted-foreground py-8 text-center">
            No articles in this series yet.
          </p>
        )}
      </section>

      <!-- Back navigation -->
      <nav class="py-8 border-t border-border">
        <Link
          href="/series"
          class="text-sm text-muted-foreground hover:text-foreground flex items-center gap-2 transition-colors"
        >
          <Icon name="lucide:arrow-left" class="size-4" />
          Back to all series
        </Link>
      </nav>
    </>
  ) : (
    <!-- Not found state -->
    <section class="py-12 text-center">
      <p class="text-xl text-muted-foreground">
        No series found! Soon to come ðŸš€
      </p>
    </section>
  )}
</Layout>
